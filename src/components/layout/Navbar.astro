---
import NavbarCart from "../islands/NavbarCart";

const links = [
  { name: "Inicio", href: "/" },
  { name: "Entradas", href: "/events" },
  { name: "Tienda", href: "/merch" },
  { name: "Comunidad", href: "/community" },
  { name: "Mapa", href: "/location" },
  { name: "Dashboard", href: "/admin/dashboard" },
  { name: "Nosotros", href: "/about" },
  { name: "Contacto", href: "/contact" },
];

const currentPath = Astro.url.pathname;

const isActive = (href: string) => {
  // Special handling for the root path
  if (href === "/" && currentPath !== "/") {
    return false;
  }
  // Check if current path starts with the link's href, for sub-routes
  return currentPath.startsWith(href);
};
---

<div class="navbar sticky top-0 z-50 bg-base-100/80 backdrop-blur-md shadow-sm transition-all duration-300">
  <div class="navbar-start">
    <a href="/" class="btn btn-ghost text-sm md:text-lg lg:text-xl font-bold px-2 md:px-4 min-h-11 py-2 leading-relaxed overflow-visible">AstroTickets</a>
  </div>
  <div class="navbar-center hidden lg:flex">
    <ul class="menu menu-horizontal px-1">
      {links.map((link) => (
        <li>
          <a
            href={link.href}
            aria-current={isActive(link.href) ? 'page' : undefined}
            class:list={[
              "relative px-3 py-2 rounded-lg transition-all duration-300",
              "hover:bg-primary/10 hover:text-primary",
              {
                "text-primary font-semibold after:absolute after:bottom-0 after:left-0 after:w-full after:h-0.5 after:bg-primary after:scale-x-100": isActive(link.href),
                "text-base-content after:absolute after:bottom-0 after:left-0 after:w-full after:h-0.5 after:bg-primary after:scale-x-0 hover:after:scale-x-100 after:transition-transform after:duration-300": !isActive(link.href)
              }
            ]}
          >
            {link.name}
          </a>
        </li>
      ))}
    </ul>
  </div>
  <div class="navbar-end gap-2">
    {/* React Island: Cart Widget */}
    <NavbarCart client:load />

    {/* Selector de Tema ‚Äî WCAG 2.1 AAA con radiogroup */}
    <div class="relative" id="theme-dropdown-wrapper">
      {/* Boton trigger */}
      <button
        type="button"
        id="theme-selector-btn"
        class="btn btn-ghost btn-circle text-2xl min-w-12 min-h-12"
        aria-haspopup="true"
        aria-expanded="false"
        aria-controls="theme-panel"
        aria-label="Cambiar tema"
      >
        <span id="icon-light" class="theme-icon-group hidden">
          <span aria-hidden="true">‚òÄÔ∏è</span>
        </span>
        <span id="icon-winter" class="theme-icon-group hidden">
          <span aria-hidden="true">‚ùÑÔ∏è</span>
        </span>
        <span id="icon-lemonade" class="theme-icon-group hidden">
          <span aria-hidden="true">üçã</span>
        </span>
        <span id="icon-cyberpunk" class="theme-icon-group hidden">
          <span aria-hidden="true">üåë</span>
        </span>
      </button>

      {/* Panel dropdown */}
      <div
        id="theme-panel"
        class="absolute right-0 top-full mt-2 z-[1] p-2 rounded-xl w-56
               bg-base-100 border-2 border-base-300 shadow-xl
               opacity-0 pointer-events-none scale-95"
        role="radiogroup"
        aria-labelledby="theme-panel-label"
      >
        <span id="theme-panel-label" class="sr-only">Seleccionar tema</span>

        {/* Claro ‚Äî Light: #1f2937 en #ffffff = 12.6:1 (AAA) */}
        <div
          class="theme-option flex items-center justify-between px-4 py-3 rounded-lg
                 min-h-[48px] select-none"
          role="radio"
          aria-checked="false"
          tabindex="-1"
          data-theme-value="light"
          data-theme-label="Claro"
        >
          <span class="flex items-center gap-3">
            <svg class="theme-check-icon w-5 h-5 text-primary opacity-0 shrink-0" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            <span class="font-bold theme-option-text">Claro</span>
          </span>
          <span>
            <span aria-hidden="true" class="text-xl">‚òÄÔ∏è</span>
            <span class="sr-only">Sol</span>
          </span>
        </div>

        {/* Invierno ‚Äî Winter: #394e6a en #ffffff = 7.4:1 (AAA) */}
        <div
          class="theme-option flex items-center justify-between px-4 py-3 rounded-lg
                 min-h-[48px] select-none"
          role="radio"
          aria-checked="false"
          tabindex="-1"
          data-theme-value="winter"
          data-theme-label="Invierno"
        >
          <span class="flex items-center gap-3">
            <svg class="theme-check-icon w-5 h-5 text-primary opacity-0 shrink-0" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            <span class="font-bold theme-option-text">Invierno</span>
          </span>
          <span>
            <span aria-hidden="true" class="text-xl">‚ùÑÔ∏è</span>
            <span class="sr-only">Copo de nieve</span>
          </span>
        </div>

        {/* Limonada ‚Äî Lemonade: #374151 en #f9f7f0 = 8.1:1 (AAA con override) */}
        <div
          class="theme-option flex items-center justify-between px-4 py-3 rounded-lg
                 min-h-[48px] select-none"
          role="radio"
          aria-checked="false"
          tabindex="-1"
          data-theme-value="lemonade"
          data-theme-label="Limonada"
        >
          <span class="flex items-center gap-3">
            <svg class="theme-check-icon w-5 h-5 text-primary opacity-0 shrink-0" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            <span class="font-bold theme-option-text">Limonada</span>
          </span>
          <span>
            <span aria-hidden="true" class="text-xl">üçã</span>
            <span class="sr-only">Lim√≥n</span>
          </span>
        </div>

        {/* Oscuro ‚Äî Cyberpunk: #ffeebb en #120024 = 13.2:1 (AAA) */}
        <div
          class="theme-option flex items-center justify-between px-4 py-3 rounded-lg
                 min-h-[48px] select-none"
          role="radio"
          aria-checked="false"
          tabindex="-1"
          data-theme-value="cyberpunk"
          data-theme-label="Oscuro"
        >
          <span class="flex items-center gap-3">
            <svg class="theme-check-icon w-5 h-5 text-primary opacity-0 shrink-0" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            <span class="font-bold theme-option-text">Oscuro</span>
          </span>
          <span>
            <span aria-hidden="true" class="text-xl">üåë</span>
            <span class="sr-only">Luna oscura</span>
          </span>
        </div>
      </div>

      {/* Region aria-live para anunciar cambios de tema */}
      <div id="theme-live-region" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    </div>

    {/* Mobile Menu Dropdown - DaisyUI Native */}
    <div class="dropdown dropdown-end lg:hidden">
      <div tabindex="0" role="button" class="btn btn-ghost min-w-11 min-h-11" aria-label="Men√∫">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </div>
      <ul tabindex="0" class="menu dropdown-content z-[1] w-56 rounded-xl shadow-2xl bg-base-300 border border-primary/40 p-2 space-y-1 mt-4">
        {links.map((link) => (
          <li>
            <a
              href={link.href}
              aria-current={isActive(link.href) ? 'page' : undefined}
              class:list={[
                "font-bold text-base-content px-4 py-3 rounded-lg transition-all hover:bg-primary/20 hover:text-primary hover:ring-2 hover:ring-primary/40",
                {
                  "bg-primary/25 text-primary ring-2 ring-primary/50": isActive(link.href)
                }
              ]}
            >
              {link.name}
            </a>
          </li>
        ))}
      </ul>
    </div>
  </div>
</div>

<style>
  /* === SELECTOR DE TEMAS ‚Äî WCAG 2.1 AAA ===
   *
   * Ratios de contraste (texto sobre bg-base-100 del panel):
   * Light:     #1f2937 en #ffffff  = 12.6:1 (AAA)
   * Winter:    #394e6a en #ffffff  = 7.4:1  (AAA)
   * Lemonade:  #374151 en #f9f7f0 = 8.1:1  (AAA, override aplicado)
   * Cyberpunk: #ffeebb en #120024 = 13.2:1 (AAA)
   *
   * Contraste de UI (borders, iconos): >= 3:1 en los 4 temas
   */

  /* Override Lemonade: base-content #4b5563 da 6.4:1, insuficiente para AAA */
  :global([data-theme="lemonade"]) .theme-option-text {
    color: #374151; /* gray-700 en #f9f7f0 = 8.1:1 (AAA) */
  }

  /* Panel abierto */
  #theme-panel.is-open {
    opacity: 1;
    pointer-events: auto;
    transform: scale(1);
  }

  /* Tema activo: border prominente + shadow + scale + check visible */
  .theme-option[aria-checked="true"] {
    border: 3px solid color-mix(in srgb, var(--color-primary) 70%, transparent);
    background-color: color-mix(in srgb, var(--color-primary) 12%, transparent);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    transform: scale(1.03);
  }

  .theme-option[aria-checked="true"] .theme-check-icon {
    opacity: 1;
  }

  .theme-option[aria-checked="true"] .theme-option-text {
    color: var(--color-primary);
  }

  /* Temas inactivos: border sutil */
  .theme-option[aria-checked="false"] {
    border: 1px solid color-mix(in srgb, var(--color-base-300) 50%, transparent);
  }

  /* Hover en opciones */
  .theme-option:hover {
    background-color: color-mix(in srgb, var(--color-primary) 10%, transparent);
  }

  /* Focus visible: 3px outline + 2px offset (WCAG AAA) */
  .theme-option:focus-visible {
    outline: 3px solid var(--color-primary);
    outline-offset: 2px;
  }

  #theme-selector-btn:focus-visible {
    outline: 3px solid var(--color-primary);
    outline-offset: 2px;
  }

  .theme-option:focus,
  #theme-selector-btn:focus {
    outline: none;
  }
</style>

<script>
  // === SELECTOR DE TEMAS ‚Äî WCAG 2.1 AAA ===
  // Radiogroup accesible con navegacion por teclado, GSAP micro-interacciones,
  // aria-live para anuncios, y persistencia via localStorage.

  import { gsap } from "gsap";

  const VALID_THEMES = ['light', 'winter', 'lemonade', 'cyberpunk'] as const;
  type ThemeValue = typeof VALID_THEMES[number];

  const THEME_LABELS: Record<ThemeValue, string> = {
    light: 'Claro',
    winter: 'Invierno',
    lemonade: 'Limonada',
    cyberpunk: 'Oscuro',
  };

  const ICON_MAP: Record<ThemeValue, string> = {
    light: 'icon-light',
    winter: 'icon-winter',
    lemonade: 'icon-lemonade',
    cyberpunk: 'icon-cyberpunk',
  };

  // Detectar preferencia de movimiento reducido
  function prefersReducedMotion(): boolean {
    return window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  }

  // Obtener tema actual validado
  function getCurrentTheme(): ThemeValue {
    const theme = document.documentElement.getAttribute('data-theme');
    return (VALID_THEMES as readonly string[]).includes(theme ?? '') ? theme as ThemeValue : 'light';
  }

  // Actualizar icono del boton trigger
  function updateThemeIcon(): void {
    const currentTheme = getCurrentTheme();
    document.querySelectorAll('.theme-icon-group').forEach(g => g.classList.add('hidden'));
    const activeIcon = document.getElementById(ICON_MAP[currentTheme]);
    if (activeIcon) activeIcon.classList.remove('hidden');
  }

  // Abrir panel con GSAP slide-down
  function openPanel(panel: HTMLElement, btn: HTMLElement): void {
    gsap.killTweensOf(panel);
    panel.classList.add('is-open');
    btn.setAttribute('aria-expanded', 'true');

    if (!prefersReducedMotion()) {
      gsap.fromTo(panel,
        { opacity: 0, scale: 0.95, y: -8 },
        { opacity: 1, scale: 1, y: 0, duration: 0.2, ease: 'power2.out' }
      );
    }

    // Foco en la opcion activa
    const selected = panel.querySelector<HTMLElement>('[aria-checked="true"]');
    if (selected) selected.focus();
  }

  // Cerrar panel con GSAP slide-up
  function closePanel(panel: HTMLElement, btn: HTMLElement, returnFocus = true): void {
    gsap.killTweensOf(panel);
    btn.setAttribute('aria-expanded', 'false');

    const doClose = () => panel.classList.remove('is-open');

    if (!prefersReducedMotion()) {
      gsap.to(panel, {
        opacity: 0, scale: 0.95, y: -8,
        duration: 0.15, ease: 'power2.in',
        onComplete: doClose
      });
    } else {
      doClose();
    }

    if (returnFocus) btn.focus();
  }

  // Seleccionar tema: actualizar ARIA, DOM, localStorage, icono, anuncio
  function selectTheme(
    themeValue: string,
    options: HTMLElement[],
    panel: HTMLElement,
  ): void {
    if (!(VALID_THEMES as readonly string[]).includes(themeValue)) return;

    // Actualizar aria-checked y tabindex (roving tabindex)
    options.forEach(opt => {
      const isSelected = opt.dataset.themeValue === themeValue;
      opt.setAttribute('aria-checked', String(isSelected));
      opt.setAttribute('tabindex', isSelected ? '0' : '-1');
    });

    // Aplicar tema
    document.documentElement.setAttribute('data-theme', themeValue);
    localStorage.setItem('theme', themeValue);
    updateThemeIcon();

    // Anunciar cambio via aria-live
    const liveRegion = document.getElementById('theme-live-region');
    if (liveRegion) {
      liveRegion.textContent = `Tema ${THEME_LABELS[themeValue as ThemeValue]} activado`;
    }

    // GSAP bounce en la opcion seleccionada
    if (!prefersReducedMotion()) {
      const selectedOpt = panel.querySelector(`[data-theme-value="${themeValue}"]`);
      if (selectedOpt) {
        gsap.fromTo(selectedOpt,
          { scale: 0.95 },
          { scale: 1.03, duration: 0.3, ease: 'back.out(1.7)' }
        );
      }
    }
  }

  // Navegacion por teclado dentro del radiogroup
  function handleKeyDown(
    e: KeyboardEvent,
    options: HTMLElement[],
    panel: HTMLElement,
    btn: HTMLElement
  ): void {
    const currentIndex = options.indexOf(document.activeElement as HTMLElement);

    switch (e.key) {
      case 'ArrowDown':
      case 'ArrowRight': {
        e.preventDefault();
        const next = (currentIndex + 1) % options.length;
        options[next].focus();
        break;
      }
      case 'ArrowUp':
      case 'ArrowLeft': {
        e.preventDefault();
        const prev = (currentIndex - 1 + options.length) % options.length;
        options[prev].focus();
        break;
      }
      case 'Home': {
        e.preventDefault();
        options[0].focus();
        break;
      }
      case 'End': {
        e.preventDefault();
        options[options.length - 1].focus();
        break;
      }
      case 'Enter':
      case ' ': {
        e.preventDefault();
        if (currentIndex >= 0) {
          const val = options[currentIndex].dataset.themeValue;
          if (val) selectTheme(val, options, panel);
          closePanel(panel, btn);
        }
        break;
      }
      case 'Escape': {
        e.preventDefault();
        closePanel(panel, btn);
        break;
      }
      case 'Tab': {
        // Cerrar panel y permitir flujo natural de foco
        closePanel(panel, btn, false);
        break;
      }
    }
  }

  // GSAP hover: elevacion suave en opciones inactivas
  function setupHoverAnimations(options: HTMLElement[], signal: AbortSignal): void {
    if (prefersReducedMotion()) return;

    options.forEach(opt => {
      opt.addEventListener('mouseenter', () => {
        if (opt.getAttribute('aria-checked') !== 'true') {
          gsap.to(opt, { y: -2, duration: 0.2, ease: 'power2.out' });
        }
      }, { signal });

      opt.addEventListener('mouseleave', () => {
        if (opt.getAttribute('aria-checked') !== 'true') {
          gsap.to(opt, { y: 0, duration: 0.2, ease: 'power2.out' });
        }
      }, { signal });
    });
  }

  // === INICIALIZACION PRINCIPAL ===
  let abortController: AbortController | undefined;

  function initThemeSelector(): void {
    // Limpiar listeners previos (evita acumulacion en View Transitions)
    if (abortController) abortController.abort();
    abortController = new AbortController();
    const signal = abortController.signal;

    const btn = document.getElementById('theme-selector-btn');
    const panel = document.getElementById('theme-panel');
    const wrapper = document.getElementById('theme-dropdown-wrapper');
    if (!btn || !panel || !wrapper) return;

    const options = Array.from(panel.querySelectorAll<HTMLElement>('.theme-option'));
    const currentTheme = getCurrentTheme();

    // Sincronizar estado ARIA con tema actual
    options.forEach(opt => {
      const isSelected = opt.dataset.themeValue === currentTheme;
      opt.setAttribute('aria-checked', String(isSelected));
      opt.setAttribute('tabindex', isSelected ? '0' : '-1');
    });

    updateThemeIcon();

    // Toggle panel al hacer clic en el trigger
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = btn.getAttribute('aria-expanded') === 'true';
      if (isOpen) {
        closePanel(panel, btn);
      } else {
        openPanel(panel, btn);
      }
    }, { signal });

    // Teclado en trigger: abrir con ArrowDown/Enter/Space
    btn.addEventListener('keydown', (e) => {
      if (['ArrowDown', 'Enter', ' '].includes(e.key)) {
        e.preventDefault();
        if (btn.getAttribute('aria-expanded') !== 'true') {
          openPanel(panel, btn);
        }
      }
    }, { signal });

    // Navegacion por teclado dentro del radiogroup
    panel.addEventListener('keydown', (e) => {
      handleKeyDown(e as KeyboardEvent, options, panel, btn);
    }, { signal });

    // Clic en opciones: seleccionar y cerrar
    options.forEach(opt => {
      opt.addEventListener('click', () => {
        const val = opt.dataset.themeValue;
        if (val) selectTheme(val, options, panel);
        closePanel(panel, btn);
      }, { signal });
    });

    // Cerrar al hacer clic fuera del wrapper
    document.addEventListener('click', (e) => {
      if (!wrapper.contains(e.target as Node) && btn.getAttribute('aria-expanded') === 'true') {
        closePanel(panel, btn);
      }
    }, { signal });

    // GSAP hover micro-interacciones
    setupHoverAnimations(options, signal);
  }

  // Inicializar y re-inicializar con View Transitions
  initThemeSelector();
  document.addEventListener('astro:after-swap', initThemeSelector);
  document.addEventListener('astro:page-load', initThemeSelector);
</script>